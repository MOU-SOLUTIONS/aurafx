// Project: AuraFX | Author: Mohamed Dhaoui | Date: 2024-12-26

import { Injectable, signal, computed } from '@angular/core';
import { Observable } from 'rxjs';
import { map, shareReplay } from 'rxjs/operators';
import { toObservable } from '@angular/core/rxjs-interop';

export type Language = 'en' | 'es' | 'fr';

@Injectable({
  providedIn: 'root'
})
export class TranslationService {
  private readonly LANGUAGE_STORAGE_KEY = 'aurafx-language';
  private readonly DEFAULT_LANGUAGE: Language = 'en';
  private readonly VALID_LANGUAGES: readonly Language[] = ['en', 'es', 'fr'] as const;
  private readonly translationSignalCache = new Map<string, ReturnType<typeof computed>>();

  readonly currentLanguage = signal<Language>(this.loadLanguage());
  private readonly currentLanguage$: Observable<Language>;

  private readonly translations: Readonly<Record<Language, Readonly<Record<string, string>>>> = {
    en: {
      'app.title': 'AuraFX - Forex Dashboard',
      'app.description': 'Real-time currency exchange rates and forex analytics',
      'nav.dashboard': 'Dashboard',
      'nav.converter': 'Converter',
      'nav.rates': 'Rates',
      'nav.charts': 'Charts',
      'nav.about': 'About',
      'dashboard.title': 'Forex Dashboard',
      'dashboard.subtitle': 'Real-time currency exchange rates',
      'dashboard.baseCurrency': 'Base Currency',
      'dashboard.lastUpdate': 'Last Update',
      'dashboard.viewMode': 'View Mode',
      'dashboard.viewMode.simple': 'Simple',
      'dashboard.viewMode.detailed': 'Detailed',
      'dashboard.currencyCards': 'Currency Cards',
      'dashboard.currencyAnalytics': 'Currency Analytics',
      'dashboard.error.loadFailed': 'Failed to load currency data',
      'converter.title': 'Currency Converter',
      'converter.from': 'From',
      'converter.to': 'To',
      'converter.amount': 'Amount',
      'converter.result': 'Result',
      'converter.convert': 'Convert',
      'converter.historical': 'Historical',
      'converter.multiple': 'Multiple',
      'converter.selectDate': 'Select Date',
      'converter.quickSelect': 'Quick Select',
      'converter.selectCurrency': 'Select currency',
      'converter.asFrom': 'as from',
      'converter.asTo': 'as to',
      'converter.conversionForm': 'Currency conversion form',
      'converter.currency': 'currency',
      'converter.addFavorite': 'Add to favorites',
      'converter.removeFavorite': 'Remove from favorites',
      'converter.swapCurrencies': 'Swap currencies',
      'converter.amountPresets': 'Amount presets',
      'converter.setAmount': 'Set amount to',
      'converter.amountPlaceholder': '0.00',
      'converter.exchangeRate': 'Exchange Rate',
      'converter.inverseRate': 'Inverse Rate',
      'converter.copy': 'Copy',
      'converter.copyResult': 'Copy result to clipboard',
      'converter.multipleConversions': 'Multiple currency conversions',
      'converter.convertToMultiple': 'Convert to Multiple Currencies',
      'converter.removeCurrency': 'Remove currency',
      'converter.addCurrency': 'Add currency',
      'converter.addCurrencyPlaceholder': 'Add currency...',
      'converter.convertAll': 'Convert All',
      'converter.multipleResults': 'Multiple conversion results',
      'converter.rate': 'Rate',
      'converter.recentConversions': 'Recent Conversions',
      'converter.clearHistory': 'Clear history',
      'converter.clear': 'Clear',
      'converter.error.loadCurrencies': 'Failed to load currencies',
      'converter.error.invalidRate': 'Invalid exchange rate',
      'converter.error.conversionFailed': 'Failed to convert currency. Please try again.',
      'converter.error.multipleConversionFailed': 'Failed to convert currencies. Please try again.',
      'converter.error.copyFailed': 'Failed to copy to clipboard',
      'converter.error.clearHistoryFailed': 'Failed to clear history',
      'converter.error.saveHistoryFailed': 'Failed to save history',
      'converter.error.saveFavoritesFailed': 'Failed to save favorites',
      'rates.title': 'Exchange Rates',
      'rates.search': 'Search currencies...',
      'rates.code': 'Code',
      'rates.name': 'Currency',
      'rates.rate': 'Rate',
      'rates.change24h': '24h Change',
      'rates.changePercent': 'Change %',
      'rates.currencies': 'currencies',
      'rates.viewMode': 'View Mode',
      'rates.viewMode.table': 'Table view',
      'rates.viewMode.grid': 'Grid view',
      'rates.viewMode.cards': 'Cards view',
      'rates.filters': 'Filters',
      'rates.export': 'Export',
      'rates.exportMenu': 'Export Menu',
      'rates.exportCSV': 'Export as CSV',
      'rates.exportJSON': 'Export as JSON',
      'rates.print': 'Print Table',
      'rates.share': 'Share',
      'rates.shareText': 'Check out these exchange rates on AuraFX',
      'rates.compare': 'Compare',
      'rates.advancedFilters': 'Advanced Filters',
      'rates.clearFilters': 'Clear All',
      'rates.minChange': 'Min Change %',
      'rates.maxChange': 'Max Change %',
      'rates.minRate': 'Min Rate',
      'rates.maxRate': 'Max Rate',
      'rates.minChangePlaceholder': 'e.g. -5',
      'rates.maxChangePlaceholder': 'e.g. 10',
      'rates.minRatePlaceholder': 'e.g. 0.5',
      'rates.maxRatePlaceholder': 'e.g. 2.0',
      'rates.onlyGainers': 'Only Gainers',
      'rates.onlyLosers': 'Only Losers',
      'rates.favoritesOnly': 'Favorites Only',
      'rates.columns': 'Columns',
      'rates.toggleColumn': 'Toggle column',
      'rates.selected': 'selected',
      'rates.clearSelection': 'Clear Selection',
      'rates.clear': 'Clear',
      'rates.exportSelected': 'Export Selected',
      'rates.currencyComparison': 'Currency Comparison',
      'rates.clearComparison': 'Clear Comparison',
      'rates.addToComparison': 'Add to Comparison',
      'rates.removeFromComparison': 'Remove from Comparison',
      'rates.addCurrency': 'Add currency',
      'rates.currency': 'Currency',
      'rates.comparisonTable': 'Comparison Table',
      'rates.actions': 'Actions',
      'rates.selectAll': 'Select All',
      'rates.select': 'Select',
      'rates.addFavorite': 'Add to Favorites',
      'rates.removeFavorite': 'Remove from Favorites',
      'rates.exchangeRatesTable': 'Exchange Rates Table',
      'rates.exchangeRatesGrid': 'Exchange Rates Grid',
      'rates.exchangeRatesCards': 'Exchange Rates Cards',
      'rates.page': 'Page',
      'rates.of': 'of',
      'rates.itemsPerPage': 'Items per page',
      'rates.perPage': 'per page',
      'rates.previous': 'Previous',
      'rates.next': 'Next',
      'rates.previousPage': 'Previous Page',
      'rates.nextPage': 'Next Page',
      'rates.goToPage': 'Go to page',
      'rates.ellipsis': 'More pages',
      'rates.noResults': 'No currencies found matching your filters',
      'rates.exportError': 'Error exporting data',
      'charts.title': 'Historical Charts',
      'charts.selectCurrency': 'Select Currency',
      'charts.timeRange': 'Time Range',
      'charts.timeRange.1D': '1 Day',
      'charts.timeRange.1W': '1 Week',
      'charts.timeRange.1M': '1 Month',
      'charts.timeRange.3M': '3 Months',
      'charts.timeRange.6M': '6 Months',
      'charts.timeRange.1Y': '1 Year',
      'charts.timeRange.ALL': 'All',
      'charts.1month': '1 Month',
      'charts.3months': '3 Months',
      'charts.6months': '6 Months',
      'charts.1year': '1 Year',
      'charts.chartType': 'Chart Type',
      'charts.chartType.line': 'Line',
      'charts.chartType.bar': 'Bar',
      'charts.chartType.area': 'Area',
      'charts.settings': 'Settings',
      'charts.export': 'Export',
      'charts.exportMenu': 'Export Menu',
      'charts.exportPNG': 'Export as PNG',
      'charts.exportPDF': 'Export as PDF',
      'charts.exportError': 'Error exporting chart',
      'charts.reset': 'Reset',
      'charts.resetZoom': 'Reset Zoom',
      'charts.customDateRange': 'Custom Date Range',
      'charts.usePresetRange': 'Use Preset Range',
      'charts.startDate': 'Start Date',
      'charts.endDate': 'End Date',
      'charts.compareWith': 'Compare With',
      'charts.max5': 'Max 5',
      'charts.addCurrency': 'Add Currency',
      'charts.removeCurrency': 'Remove Currency',
      'charts.showGrid': 'Show Grid',
      'charts.showLegend': 'Show Legend',
      'charts.smoothCurves': 'Smooth Curves',
      'charts.showDataPoints': 'Show Data Points',
      'charts.showPerformanceMetrics': 'Show Performance Metrics',
      'charts.showDataTable': 'Show Data Table',
      'charts.technicalIndicators': 'Technical Indicators',
      'charts.movingAverage': 'Moving Average',
      'charts.maPeriod': 'MA Period',
      'charts.exponentialMA': 'Exponential Moving Average',
      'charts.emaPeriod': 'EMA Period',
      'charts.periodHigh': 'Period High',
      'charts.periodLow': 'Period Low',
      'charts.average': 'Average',
      'charts.change': 'Change',
      'charts.changePercent': 'Change %',
      'charts.volatility': 'Volatility',
      'charts.trend': 'Trend',
      'charts.trend.up': 'Up',
      'charts.trend.down': 'Down',
      'charts.trend.neutral': 'Neutral',
      'charts.chart': 'Currency Chart',
      'charts.historicalData': 'Historical Data',
      'charts.date': 'Date',
      'charts.rate': 'Rate',
      'cards.loading': 'Loading...',
      'cards.error': 'Error loading data',
      'analytics.cardFor': 'Analytics card for',
      'analytics.trend': 'Trend',
      'analytics.currentRate': 'Current Exchange Rate',
      'analytics.metrics': 'Analytics Metrics',
      'analytics.avg7Days': '7-Day Average',
      'analytics.avg30Days': '30-Day Average',
      'analytics.weekHigh': 'Week High',
      'analytics.weekLow': 'Week Low',
      'analytics.monthHigh': 'Month High',
      'analytics.monthLow': 'Month Low',
      'analytics.volatility': 'Volatility',
      'analytics.volatilityLevel.low': 'Low',
      'analytics.volatilityLevel.medium': 'Medium',
      'analytics.volatilityLevel.high': 'High',
      'analytics.priceRange': 'Price Range',
      'analytics.priceRange7Days': 'Price Range (7 days)',
      'analytics.currentPricePosition': 'Current price position in range',
      'analytics.error.invalidCurrency': 'Invalid currency data',
      'analytics.error.loadFailed': 'Failed to load analytics data',
      'market.title': 'Market Overview',
      'market.statistics': 'Market Statistics',
      'market.totalCurrencies': 'Total Currencies',
      'market.gainers': 'Gainers',
      'market.losers': 'Losers',
      'market.neutral': 'Neutral',
      'market.averageChange': 'Average Change',
      'market.topMovers': 'Top Movers',
      'market.topGainers': 'Top Gainers',
      'market.topLosers': 'Top Losers',
      'market.noGainers': 'No gainers available',
      'market.noLosers': 'No losers available',
      'market.strengthIndex': 'Currency Strength Index',
      'market.strongest': 'Strongest Currencies',
      'market.weakest': 'Weakest Currencies',
      'market.change24h': '24h',
      'market.change7d': '7d',
      'market.change30d': '30d',
      'market.currencyStrength': 'Currency Strength',
      'market.strength': 'Strength',
      'market.strengthBar': 'Strength Bar',
      'market.changeDetails': 'Change Details',
      'market.topIndicators': 'Top Strength Indicators',
      'market.rank': 'Rank',
      'market.noStrongCurrencies': 'No strong currencies available',
      'market.noWeakCurrencies': 'No weak currencies available',
      'market.error.loadFailed': 'Failed to load market data',
      'multiChart.title': 'Multi-Currency Comparison',
      'multiChart.controls': 'Chart Controls',
      'multiChart.chartType': 'Chart Type',
      'multiChart.line': 'Line',
      'multiChart.bar': 'Bar',
      'multiChart.selectCurrencies': 'Select Currencies',
      'multiChart.max': 'max',
      'multiChart.availableCurrencies': 'Available Currencies',
      'multiChart.deselect': 'Deselect',
      'multiChart.select': 'Select',
      'multiChart.selected': 'Selected',
      'multiChart.chartDisplay': 'Chart Display',
      'multiChart.error.loadCurrencies': 'Failed to load currencies',
      'multiChart.error.noCurrencies': 'Please select at least one currency',
      'multiChart.error.invalidDate': 'Invalid date format',
      'multiChart.error.loadFailed': 'Failed to load chart data',
      'multiChart.error.noData': 'No data available for the selected period',
      'insights.title': 'Currency Insights',
      'insights.subtitle': 'Market statistics and performance trends',
      'insights.marketStats': 'Market Statistics',
      'insights.totalCurrencies': 'Total Currencies',
      'insights.gainers': 'Gainers',
      'insights.losers': 'Losers',
      'insights.avgVolatility': 'Avg Volatility',
      'insights.topGainers': 'Top Gainers (24h)',
      'insights.topLosers': 'Top Losers (24h)',
      'insights.weekPerformers': 'Week Performers',
      'insights.mostVolatile': 'Most Volatile',
      'insights.best': 'Best',
      'insights.worst': 'Worst',
      'insights.noGainers': 'No gainers available',
      'insights.noLosers': 'No losers available',
      'insights.loadingData': 'Loading data...',
      'insights.error.loadFailed': 'Failed to load insights data',
      'common.refresh': 'Refresh',
      'common.select': 'Select',
      'common.search': 'Search',
      'common.retry': 'Retry',
      'theme.dark': 'Dark',
      'theme.light': 'Light',
      'theme.toggle': 'Toggle theme',
      'theme.current': 'Current theme'
    },
    es: {
      'app.title': 'AuraFX - Panel de Divisas',
      'app.description': 'Tasas de cambio de divisas en tiempo real y análisis forex',
      'nav.dashboard': 'Panel',
      'nav.converter': 'Convertidor',
      'nav.rates': 'Tasas',
      'nav.charts': 'Gráficos',
      'nav.about': 'Acerca de',
      'dashboard.title': 'Panel de Divisas',
      'dashboard.subtitle': 'Tasas de cambio de divisas en tiempo real',
      'dashboard.baseCurrency': 'Moneda Base',
      'dashboard.lastUpdate': 'Última Actualización',
      'dashboard.viewMode': 'Modo de Vista',
      'dashboard.viewMode.simple': 'Simple',
      'dashboard.viewMode.detailed': 'Detallado',
      'dashboard.currencyCards': 'Tarjetas de Divisas',
      'dashboard.currencyAnalytics': 'Análisis de Divisas',
      'dashboard.error.loadFailed': 'Error al cargar datos de divisas',
      'converter.title': 'Convertidor de Divisas',
      'converter.from': 'Desde',
      'converter.to': 'Hacia',
      'converter.amount': 'Cantidad',
      'converter.result': 'Resultado',
      'converter.convert': 'Convertir',
      'converter.historical': 'Histórico',
      'converter.multiple': 'Múltiple',
      'converter.selectDate': 'Seleccionar Fecha',
      'converter.quickSelect': 'Selección Rápida',
      'converter.selectCurrency': 'Seleccionar divisa',
      'converter.asFrom': 'como desde',
      'converter.asTo': 'como hacia',
      'converter.conversionForm': 'Formulario de conversión de divisas',
      'converter.currency': 'divisa',
      'converter.addFavorite': 'Agregar a favoritos',
      'converter.removeFavorite': 'Quitar de favoritos',
      'converter.swapCurrencies': 'Intercambiar divisas',
      'converter.amountPresets': 'Cantidades preestablecidas',
      'converter.setAmount': 'Establecer cantidad en',
      'converter.amountPlaceholder': '0.00',
      'converter.exchangeRate': 'Tasa de Cambio',
      'converter.inverseRate': 'Tasa Inversa',
      'converter.copy': 'Copiar',
      'converter.copyResult': 'Copiar resultado al portapapeles',
      'converter.multipleConversions': 'Conversiones de múltiples divisas',
      'converter.convertToMultiple': 'Convertir a Múltiples Divisas',
      'converter.removeCurrency': 'Quitar divisa',
      'converter.addCurrency': 'Agregar divisa',
      'converter.addCurrencyPlaceholder': 'Agregar divisa...',
      'converter.convertAll': 'Convertir Todo',
      'converter.multipleResults': 'Resultados de conversión múltiple',
      'converter.rate': 'Tasa',
      'converter.recentConversions': 'Conversiones Recientes',
      'converter.clearHistory': 'Limpiar historial',
      'converter.clear': 'Limpiar',
      'converter.error.loadCurrencies': 'Error al cargar divisas',
      'converter.error.invalidRate': 'Tasa de cambio inválida',
      'converter.error.conversionFailed': 'Error al convertir divisa. Por favor, intente de nuevo.',
      'converter.error.multipleConversionFailed': 'Error al convertir divisas. Por favor, intente de nuevo.',
      'converter.error.copyFailed': 'Error al copiar al portapapeles',
      'converter.error.clearHistoryFailed': 'Error al limpiar historial',
      'converter.error.saveHistoryFailed': 'Error al guardar historial',
      'converter.error.saveFavoritesFailed': 'Error al guardar favoritos',
      'rates.title': 'Tasas de Cambio',
      'rates.search': 'Buscar divisas...',
      'rates.code': 'Código',
      'rates.name': 'Divisa',
      'rates.rate': 'Tasa',
      'rates.change24h': 'Cambio 24h',
      'rates.changePercent': 'Cambio %',
      'rates.currencies': 'divisas',
      'rates.viewMode': 'Modo de Vista',
      'rates.viewMode.table': 'Vista de tabla',
      'rates.viewMode.grid': 'Vista de cuadrícula',
      'rates.viewMode.cards': 'Vista de tarjetas',
      'rates.filters': 'Filtros',
      'rates.export': 'Exportar',
      'rates.exportMenu': 'Menú de Exportación',
      'rates.exportCSV': 'Exportar como CSV',
      'rates.exportJSON': 'Exportar como JSON',
      'rates.print': 'Imprimir Tabla',
      'rates.share': 'Compartir',
      'rates.shareText': 'Mira estas tasas de cambio en AuraFX',
      'rates.compare': 'Comparar',
      'rates.advancedFilters': 'Filtros Avanzados',
      'rates.clearFilters': 'Limpiar Todo',
      'rates.minChange': 'Cambio Mín %',
      'rates.maxChange': 'Cambio Máx %',
      'rates.minRate': 'Tasa Mínima',
      'rates.maxRate': 'Tasa Máxima',
      'rates.minChangePlaceholder': 'ej. -5',
      'rates.maxChangePlaceholder': 'ej. 10',
      'rates.minRatePlaceholder': 'ej. 0.5',
      'rates.maxRatePlaceholder': 'ej. 2.0',
      'rates.onlyGainers': 'Solo Ganadores',
      'rates.onlyLosers': 'Solo Perdedores',
      'rates.favoritesOnly': 'Solo Favoritos',
      'rates.columns': 'Columnas',
      'rates.toggleColumn': 'Alternar columna',
      'rates.selected': 'seleccionadas',
      'rates.clearSelection': 'Limpiar Selección',
      'rates.clear': 'Limpiar',
      'rates.exportSelected': 'Exportar Seleccionadas',
      'rates.currencyComparison': 'Comparación de Divisas',
      'rates.clearComparison': 'Limpiar Comparación',
      'rates.addToComparison': 'Agregar a Comparación',
      'rates.removeFromComparison': 'Quitar de Comparación',
      'rates.addCurrency': 'Agregar divisa',
      'rates.currency': 'Divisa',
      'rates.comparisonTable': 'Tabla de Comparación',
      'rates.actions': 'Acciones',
      'rates.selectAll': 'Seleccionar Todo',
      'rates.select': 'Seleccionar',
      'rates.addFavorite': 'Agregar a Favoritos',
      'rates.removeFavorite': 'Quitar de Favoritos',
      'rates.exchangeRatesTable': 'Tabla de Tasas de Cambio',
      'rates.exchangeRatesGrid': 'Cuadrícula de Tasas de Cambio',
      'rates.exchangeRatesCards': 'Tarjetas de Tasas de Cambio',
      'rates.page': 'Página',
      'rates.of': 'de',
      'rates.itemsPerPage': 'Elementos por página',
      'rates.perPage': 'por página',
      'rates.previous': 'Anterior',
      'rates.next': 'Siguiente',
      'rates.previousPage': 'Página Anterior',
      'rates.nextPage': 'Página Siguiente',
      'rates.goToPage': 'Ir a página',
      'rates.ellipsis': 'Más páginas',
      'rates.noResults': 'No se encontraron divisas que coincidan con sus filtros',
      'rates.exportError': 'Error al exportar datos',
      'charts.title': 'Gráficos Históricos',
      'charts.selectCurrency': 'Seleccionar Divisa',
      'charts.timeRange': 'Rango de Tiempo',
      'charts.timeRange.1D': '1 Día',
      'charts.timeRange.1W': '1 Semana',
      'charts.timeRange.1M': '1 Mes',
      'charts.timeRange.3M': '3 Meses',
      'charts.timeRange.6M': '6 Meses',
      'charts.timeRange.1Y': '1 Año',
      'charts.timeRange.ALL': 'Todo',
      'charts.1month': '1 Mes',
      'charts.3months': '3 Meses',
      'charts.6months': '6 Meses',
      'charts.1year': '1 Año',
      'charts.chartType': 'Tipo de Gráfico',
      'charts.chartType.line': 'Línea',
      'charts.chartType.bar': 'Barras',
      'charts.chartType.area': 'Área',
      'charts.settings': 'Configuración',
      'charts.export': 'Exportar',
      'charts.exportMenu': 'Menú de Exportación',
      'charts.exportPNG': 'Exportar como PNG',
      'charts.exportPDF': 'Exportar como PDF',
      'charts.exportError': 'Error al exportar gráfico',
      'charts.reset': 'Restablecer',
      'charts.resetZoom': 'Restablecer Zoom',
      'charts.customDateRange': 'Rango de Fechas Personalizado',
      'charts.usePresetRange': 'Usar Rango Predefinido',
      'charts.startDate': 'Fecha de Inicio',
      'charts.endDate': 'Fecha de Fin',
      'charts.compareWith': 'Comparar Con',
      'charts.max5': 'Máx 5',
      'charts.addCurrency': 'Agregar Divisa',
      'charts.removeCurrency': 'Eliminar Divisa',
      'charts.showGrid': 'Mostrar Cuadrícula',
      'charts.showLegend': 'Mostrar Leyenda',
      'charts.smoothCurves': 'Curvas Suaves',
      'charts.showDataPoints': 'Mostrar Puntos de Datos',
      'charts.showPerformanceMetrics': 'Mostrar Métricas de Rendimiento',
      'charts.showDataTable': 'Mostrar Tabla de Datos',
      'charts.technicalIndicators': 'Indicadores Técnicos',
      'charts.movingAverage': 'Media Móvil',
      'charts.maPeriod': 'Período MA',
      'charts.exponentialMA': 'Media Móvil Exponencial',
      'charts.emaPeriod': 'Período EMA',
      'charts.periodHigh': 'Máximo del Período',
      'charts.periodLow': 'Mínimo del Período',
      'charts.average': 'Promedio',
      'charts.change': 'Cambio',
      'charts.changePercent': 'Cambio %',
      'charts.volatility': 'Volatilidad',
      'charts.trend': 'Tendencia',
      'charts.trend.up': 'Alza',
      'charts.trend.down': 'Baja',
      'charts.trend.neutral': 'Neutral',
      'charts.chart': 'Gráfico de Divisas',
      'charts.historicalData': 'Datos Históricos',
      'charts.date': 'Fecha',
      'charts.rate': 'Tasa',
      'cards.loading': 'Cargando...',
      'cards.error': 'Error al cargar datos',
      'analytics.cardFor': 'Tarjeta de análisis para',
      'analytics.trend': 'Tendencia',
      'analytics.currentRate': 'Tasa de Cambio Actual',
      'analytics.metrics': 'Métricas de Análisis',
      'analytics.avg7Days': 'Promedio 7 Días',
      'analytics.avg30Days': 'Promedio 30 Días',
      'analytics.weekHigh': 'Máximo Semanal',
      'analytics.weekLow': 'Mínimo Semanal',
      'analytics.monthHigh': 'Máximo Mensual',
      'analytics.monthLow': 'Mínimo Mensual',
      'analytics.volatility': 'Volatilidad',
      'analytics.volatilityLevel.low': 'Baja',
      'analytics.volatilityLevel.medium': 'Media',
      'analytics.volatilityLevel.high': 'Alta',
      'analytics.priceRange': 'Rango de Precios',
      'analytics.priceRange7Days': 'Rango de Precios (7 días)',
      'analytics.currentPricePosition': 'Posición del precio actual en el rango',
      'analytics.error.invalidCurrency': 'Datos de divisa inválidos',
      'analytics.error.loadFailed': 'Error al cargar datos de análisis',
      'market.title': 'Resumen del Mercado',
      'market.statistics': 'Estadísticas del Mercado',
      'market.totalCurrencies': 'Total de Divisas',
      'market.gainers': 'Ganadores',
      'market.losers': 'Perdedores',
      'market.neutral': 'Neutral',
      'market.averageChange': 'Cambio Promedio',
      'market.topMovers': 'Principales Movimientos',
      'market.topGainers': 'Principales Ganadores',
      'market.topLosers': 'Principales Perdedores',
      'market.noGainers': 'No hay ganadores disponibles',
      'market.noLosers': 'No hay perdedores disponibles',
      'market.strengthIndex': 'Índice de Fortaleza de Divisas',
      'market.strongest': 'Divisas Más Fuertes',
      'market.weakest': 'Divisas Más Débiles',
      'market.change24h': '24h',
      'market.change7d': '7d',
      'market.change30d': '30d',
      'market.currencyStrength': 'Fortaleza de Divisa',
      'market.strength': 'Fortaleza',
      'market.strengthBar': 'Barra de Fortaleza',
      'market.changeDetails': 'Detalles de Cambio',
      'market.topIndicators': 'Indicadores de Fortaleza',
      'market.rank': 'Rango',
      'market.noStrongCurrencies': 'No hay divisas fuertes disponibles',
      'market.noWeakCurrencies': 'No hay divisas débiles disponibles',
      'market.error.loadFailed': 'Error al cargar datos del mercado',
      'multiChart.title': 'Comparación Multi-Divisa',
      'multiChart.controls': 'Controles del Gráfico',
      'multiChart.chartType': 'Tipo de Gráfico',
      'multiChart.line': 'Línea',
      'multiChart.bar': 'Barras',
      'multiChart.selectCurrencies': 'Seleccionar Divisas',
      'multiChart.max': 'máx',
      'multiChart.availableCurrencies': 'Divisas Disponibles',
      'multiChart.deselect': 'Deseleccionar',
      'multiChart.select': 'Seleccionar',
      'multiChart.selected': 'Seleccionadas',
      'multiChart.chartDisplay': 'Visualización del Gráfico',
      'multiChart.error.loadCurrencies': 'Error al cargar divisas',
      'multiChart.error.noCurrencies': 'Por favor seleccione al menos una divisa',
      'multiChart.error.invalidDate': 'Formato de fecha inválido',
      'multiChart.error.loadFailed': 'Error al cargar datos del gráfico',
      'multiChart.error.noData': 'No hay datos disponibles para el período seleccionado',
      'insights.title': 'Análisis de Divisas',
      'insights.subtitle': 'Estadísticas del mercado y tendencias de rendimiento',
      'insights.marketStats': 'Estadísticas del Mercado',
      'insights.totalCurrencies': 'Total de Divisas',
      'insights.gainers': 'Ganadores',
      'insights.losers': 'Perdedores',
      'insights.avgVolatility': 'Volatilidad Promedio',
      'insights.topGainers': 'Principales Ganadores (24h)',
      'insights.topLosers': 'Principales Perdedores (24h)',
      'insights.weekPerformers': 'Rendimiento Semanal',
      'insights.mostVolatile': 'Más Volátiles',
      'insights.best': 'Mejores',
      'insights.worst': 'Peores',
      'insights.noGainers': 'No hay ganadores disponibles',
      'insights.noLosers': 'No hay perdedores disponibles',
      'insights.loadingData': 'Cargando datos...',
      'insights.error.loadFailed': 'Error al cargar datos de análisis',
      'common.refresh': 'Actualizar',
      'common.select': 'Seleccionar',
      'common.search': 'Buscar',
      'common.retry': 'Reintentar',
      'theme.dark': 'Oscuro',
      'theme.light': 'Claro',
      'theme.toggle': 'Cambiar tema',
      'theme.current': 'Tema actual'
    },
    fr: {
      'app.title': 'AuraFX - Tableau de Bord Forex',
      'app.description': 'Taux de change en temps réel et analyses forex',
      'nav.dashboard': 'Tableau de Bord',
      'nav.converter': 'Convertisseur',
      'nav.rates': 'Taux',
      'nav.charts': 'Graphiques',
      'nav.about': 'À Propos',
      'dashboard.title': 'Tableau de Bord Forex',
      'dashboard.subtitle': 'Taux de change en temps réel',
      'dashboard.baseCurrency': 'Devise de Base',
      'dashboard.lastUpdate': 'Dernière Mise à Jour',
      'dashboard.viewMode': 'Mode d\'Affichage',
      'dashboard.viewMode.simple': 'Simple',
      'dashboard.viewMode.detailed': 'Détaillé',
      'dashboard.currencyCards': 'Cartes de Devises',
      'dashboard.currencyAnalytics': 'Analyses de Devises',
      'dashboard.error.loadFailed': 'Échec du chargement des données de devises',
      'converter.title': 'Convertisseur de Devises',
      'converter.from': 'De',
      'converter.to': 'Vers',
      'converter.amount': 'Montant',
      'converter.result': 'Résultat',
      'converter.convert': 'Convertir',
      'converter.historical': 'Historique',
      'converter.multiple': 'Multiple',
      'converter.selectDate': 'Sélectionner la Date',
      'converter.quickSelect': 'Sélection Rapide',
      'converter.selectCurrency': 'Sélectionner la devise',
      'converter.asFrom': 'comme de',
      'converter.asTo': 'comme vers',
      'converter.conversionForm': 'Formulaire de conversion de devises',
      'converter.currency': 'devise',
      'converter.addFavorite': 'Ajouter aux favoris',
      'converter.removeFavorite': 'Retirer des favoris',
      'converter.swapCurrencies': 'Échanger les devises',
      'converter.amountPresets': 'Montants prédéfinis',
      'converter.setAmount': 'Définir le montant à',
      'converter.amountPlaceholder': '0.00',
      'converter.exchangeRate': 'Taux de Change',
      'converter.inverseRate': 'Taux Inverse',
      'converter.copy': 'Copier',
      'converter.copyResult': 'Copier le résultat dans le presse-papiers',
      'converter.multipleConversions': 'Conversions de devises multiples',
      'converter.convertToMultiple': 'Convertir en Plusieurs Devises',
      'converter.removeCurrency': 'Retirer la devise',
      'converter.addCurrency': 'Ajouter une devise',
      'converter.addCurrencyPlaceholder': 'Ajouter une devise...',
      'converter.convertAll': 'Tout Convertir',
      'converter.multipleResults': 'Résultats de conversion multiple',
      'converter.rate': 'Taux',
      'converter.recentConversions': 'Conversions Récentes',
      'converter.clearHistory': 'Effacer l\'historique',
      'converter.clear': 'Effacer',
      'converter.error.loadCurrencies': 'Échec du chargement des devises',
      'converter.error.invalidRate': 'Taux de change invalide',
      'converter.error.conversionFailed': 'Échec de la conversion. Veuillez réessayer.',
      'converter.error.multipleConversionFailed': 'Échec de la conversion des devises. Veuillez réessayer.',
      'converter.error.copyFailed': 'Échec de la copie dans le presse-papiers',
      'converter.error.clearHistoryFailed': 'Échec de l\'effacement de l\'historique',
      'converter.error.saveHistoryFailed': 'Échec de l\'enregistrement de l\'historique',
      'converter.error.saveFavoritesFailed': 'Échec de l\'enregistrement des favoris',
      'rates.title': 'Taux de Change',
      'rates.search': 'Rechercher des devises...',
      'rates.code': 'Code',
      'rates.name': 'Devise',
      'rates.rate': 'Taux',
      'rates.change24h': 'Variation 24h',
      'rates.changePercent': 'Variation %',
      'rates.currencies': 'devises',
      'rates.viewMode': 'Mode d\'Affichage',
      'rates.viewMode.table': 'Vue tableau',
      'rates.viewMode.grid': 'Vue grille',
      'rates.viewMode.cards': 'Vue cartes',
      'rates.filters': 'Filtres',
      'rates.export': 'Exporter',
      'rates.exportMenu': 'Menu d\'Exportation',
      'rates.exportCSV': 'Exporter en CSV',
      'rates.exportJSON': 'Exporter en JSON',
      'rates.print': 'Imprimer le Tableau',
      'rates.share': 'Partager',
      'rates.shareText': 'Découvrez ces taux de change sur AuraFX',
      'rates.compare': 'Comparer',
      'rates.advancedFilters': 'Filtres Avancés',
      'rates.clearFilters': 'Tout Effacer',
      'rates.minChange': 'Variation Min %',
      'rates.maxChange': 'Variation Max %',
      'rates.minRate': 'Taux Minimum',
      'rates.maxRate': 'Taux Maximum',
      'rates.minChangePlaceholder': 'ex. -5',
      'rates.maxChangePlaceholder': 'ex. 10',
      'rates.minRatePlaceholder': 'ex. 0.5',
      'rates.maxRatePlaceholder': 'ex. 2.0',
      'rates.onlyGainers': 'Seulement Gagnants',
      'rates.onlyLosers': 'Seulement Perdants',
      'rates.favoritesOnly': 'Favoris Seulement',
      'rates.columns': 'Colonnes',
      'rates.toggleColumn': 'Basculer la colonne',
      'rates.selected': 'sélectionnées',
      'rates.clearSelection': 'Effacer la Sélection',
      'rates.clear': 'Effacer',
      'rates.exportSelected': 'Exporter Sélectionnées',
      'rates.currencyComparison': 'Comparaison de Devises',
      'rates.clearComparison': 'Effacer la Comparaison',
      'rates.addToComparison': 'Ajouter à la Comparaison',
      'rates.removeFromComparison': 'Retirer de la Comparaison',
      'rates.addCurrency': 'Ajouter une devise',
      'rates.currency': 'Devise',
      'rates.comparisonTable': 'Tableau de Comparaison',
      'rates.actions': 'Actions',
      'rates.selectAll': 'Tout Sélectionner',
      'rates.select': 'Sélectionner',
      'rates.addFavorite': 'Ajouter aux Favoris',
      'rates.removeFavorite': 'Retirer des Favoris',
      'rates.exchangeRatesTable': 'Tableau des Taux de Change',
      'rates.exchangeRatesGrid': 'Grille des Taux de Change',
      'rates.exchangeRatesCards': 'Cartes des Taux de Change',
      'rates.page': 'Page',
      'rates.of': 'de',
      'rates.itemsPerPage': 'Éléments par page',
      'rates.perPage': 'par page',
      'rates.previous': 'Précédent',
      'rates.next': 'Suivant',
      'rates.previousPage': 'Page Précédente',
      'rates.nextPage': 'Page Suivante',
      'rates.goToPage': 'Aller à la page',
      'rates.ellipsis': 'Plus de pages',
      'rates.noResults': 'Aucune devise trouvée correspondant à vos filtres',
      'rates.exportError': 'Erreur lors de l\'exportation des données',
      'charts.title': 'Graphiques Historiques',
      'charts.selectCurrency': 'Sélectionner une Devise',
      'charts.timeRange': 'Période',
      'charts.timeRange.1D': '1 Jour',
      'charts.timeRange.1W': '1 Semaine',
      'charts.timeRange.1M': '1 Mois',
      'charts.timeRange.3M': '3 Mois',
      'charts.timeRange.6M': '6 Mois',
      'charts.timeRange.1Y': '1 An',
      'charts.timeRange.ALL': 'Tout',
      'charts.1month': '1 Mois',
      'charts.3months': '3 Mois',
      'charts.6months': '6 Mois',
      'charts.1year': '1 An',
      'charts.chartType': 'Type de Graphique',
      'charts.chartType.line': 'Ligne',
      'charts.chartType.bar': 'Barres',
      'charts.chartType.area': 'Aire',
      'charts.settings': 'Paramètres',
      'charts.export': 'Exporter',
      'charts.exportMenu': 'Menu d\'Exportation',
      'charts.exportPNG': 'Export as PNG',
      'charts.exportPDF': 'Export as PDF',
      'charts.exportError': 'Erreur lors de l\'exportation du graphique',
      'charts.reset': 'Réinitialiser',
      'charts.resetZoom': 'Réinitialiser le Zoom',
      'charts.customDateRange': 'Plage de Dates Personnalisée',
      'charts.usePresetRange': 'Utiliser une Plage Prédéfinie',
      'charts.startDate': 'Date de Début',
      'charts.endDate': 'Date de Fin',
      'charts.compareWith': 'Comparer Avec',
      'charts.max5': 'Max 5',
      'charts.addCurrency': 'Ajouter une Devise',
      'charts.removeCurrency': 'Supprimer la Devise',
      'charts.showGrid': 'Afficher la Grille',
      'charts.showLegend': 'Afficher la Légende',
      'charts.smoothCurves': 'Courbes Lisses',
      'charts.showDataPoints': 'Afficher les Points de Données',
      'charts.showPerformanceMetrics': 'Afficher les Métriques de Performance',
      'charts.showDataTable': 'Afficher le Tableau de Données',
      'charts.technicalIndicators': 'Indicateurs Techniques',
      'charts.movingAverage': 'Moyenne Mobile',
      'charts.maPeriod': 'Période MA',
      'charts.exponentialMA': 'Moyenne Mobile Exponentielle',
      'charts.emaPeriod': 'Période EMA',
      'charts.periodHigh': 'Maximum de la Période',
      'charts.periodLow': 'Minimum de la Période',
      'charts.average': 'Moyenne',
      'charts.change': 'Changement',
      'charts.changePercent': 'Changement %',
      'charts.volatility': 'Volatilité',
      'charts.trend': 'Tendance',
      'charts.trend.up': 'Hausse',
      'charts.trend.down': 'Baisse',
      'charts.trend.neutral': 'Neutre',
      'charts.chart': 'Graphique de Devises',
      'charts.historicalData': 'Données Historiques',
      'charts.date': 'Date',
      'charts.rate': 'Taux',
      'cards.loading': 'Chargement...',
      'cards.error': 'Erreur lors du chargement des données',
      'analytics.cardFor': 'Carte d\'analyse pour',
      'analytics.trend': 'Tendance',
      'analytics.currentRate': 'Taux de Change Actuel',
      'analytics.metrics': 'Métriques d\'Analyse',
      'analytics.avg7Days': 'Moyenne 7 Jours',
      'analytics.avg30Days': 'Moyenne 30 Jours',
      'analytics.weekHigh': 'Maximum Hebdomadaire',
      'analytics.weekLow': 'Minimum Hebdomadaire',
      'analytics.monthHigh': 'Maximum Mensuel',
      'analytics.monthLow': 'Minimum Mensuel',
      'analytics.volatility': 'Volatilité',
      'analytics.volatilityLevel.low': 'Faible',
      'analytics.volatilityLevel.medium': 'Moyenne',
      'analytics.volatilityLevel.high': 'Élevée',
      'analytics.priceRange': 'Fourchette de Prix',
      'analytics.priceRange7Days': 'Fourchette de Prix (7 jours)',
      'analytics.currentPricePosition': 'Position du prix actuel dans la fourchette',
      'analytics.error.invalidCurrency': 'Données de devise invalides',
      'analytics.error.loadFailed': 'Échec du chargement des données d\'analyse',
      'market.title': 'Aperçu du Marché',
      'market.statistics': 'Statistiques du Marché',
      'market.totalCurrencies': 'Total des Devises',
      'market.gainers': 'Gagnants',
      'market.losers': 'Perdants',
      'market.neutral': 'Neutre',
      'market.averageChange': 'Changement Moyen',
      'market.topMovers': 'Principaux Mouvements',
      'market.topGainers': 'Principaux Gagnants',
      'market.topLosers': 'Principaux Perdants',
      'market.noGainers': 'Aucun gagnant disponible',
      'market.noLosers': 'Aucun perdant disponible',
      'market.strengthIndex': 'Indice de Force des Devises',
      'market.strongest': 'Devises les Plus Fortes',
      'market.weakest': 'Devises les Plus Faibles',
      'market.change24h': '24h',
      'market.change7d': '7j',
      'market.change30d': '30j',
      'market.currencyStrength': 'Force de la Devise',
      'market.strength': 'Force',
      'market.strengthBar': 'Barre de Force',
      'market.changeDetails': 'Détails des Changements',
      'market.topIndicators': 'Indicateurs de Force',
      'market.rank': 'Rang',
      'market.noStrongCurrencies': 'Aucune devise forte disponible',
      'market.noWeakCurrencies': 'Aucune devise faible disponible',
      'market.error.loadFailed': 'Échec du chargement des données du marché',
      'multiChart.title': 'Comparaison Multi-Devises',
      'multiChart.controls': 'Contrôles du Graphique',
      'multiChart.chartType': 'Type de Graphique',
      'multiChart.line': 'Ligne',
      'multiChart.bar': 'Barres',
      'multiChart.selectCurrencies': 'Sélectionner les Devises',
      'multiChart.max': 'max',
      'multiChart.availableCurrencies': 'Devises Disponibles',
      'multiChart.deselect': 'Désélectionner',
      'multiChart.select': 'Sélectionner',
      'multiChart.selected': 'Sélectionnées',
      'multiChart.chartDisplay': 'Affichage du Graphique',
      'multiChart.error.loadCurrencies': 'Échec du chargement des devises',
      'multiChart.error.noCurrencies': 'Veuillez sélectionner au moins une devise',
      'multiChart.error.invalidDate': 'Format de date invalide',
      'multiChart.error.loadFailed': 'Échec du chargement des données du graphique',
      'multiChart.error.noData': 'Aucune donnée disponible pour la période sélectionnée',
      'insights.title': 'Analyse des Devises',
      'insights.subtitle': 'Statistiques du marché et tendances de performance',
      'insights.marketStats': 'Statistiques du Marché',
      'insights.totalCurrencies': 'Total des Devises',
      'insights.gainers': 'Gagnants',
      'insights.losers': 'Perdants',
      'insights.avgVolatility': 'Volatilité Moyenne',
      'insights.topGainers': 'Meilleurs Gagnants (24h)',
      'insights.topLosers': 'Pires Perdants (24h)',
      'insights.weekPerformers': 'Performances Hebdomadaires',
      'insights.mostVolatile': 'Plus Volatiles',
      'insights.best': 'Meilleurs',
      'insights.worst': 'Pires',
      'insights.noGainers': 'Aucun gagnant disponible',
      'insights.noLosers': 'Aucun perdant disponible',
      'insights.loadingData': 'Chargement des données...',
      'insights.error.loadFailed': 'Échec du chargement des données d\'analyse',
      'common.refresh': 'Actualiser',
      'common.select': 'Sélectionner',
      'common.search': 'Rechercher',
      'common.retry': 'Réessayer',
      'theme.dark': 'Sombre',
      'theme.light': 'Clair',
      'theme.toggle': 'Changer le thème',
      'theme.current': 'Thème actuel'
    }
  } as const;

  constructor() {
    const initialLanguage = this.loadLanguage();
    this.currentLanguage.set(initialLanguage);
    this.currentLanguage$ = toObservable(this.currentLanguage).pipe(
      shareReplay({ bufferSize: 1, refCount: true })
    );
    if (typeof document !== 'undefined') {
      document.documentElement.lang = initialLanguage;
    }
  }

  getCurrentLanguage(): Observable<Language> {
    return this.currentLanguage$;
  }

  setLanguage(lang: Language): void {
    const sanitizedLang = this.sanitizeLanguage(lang);
    if (sanitizedLang !== this.currentLanguage()) {
      this.currentLanguage.set(sanitizedLang);
      this.saveLanguage(sanitizedLang);
      if (typeof document !== 'undefined') {
        document.documentElement.lang = sanitizedLang;
      }
    }
  }

  translate(key: string): string {
    const sanitizedKey = this.sanitizeKey(key);
    const lang = this.currentLanguage();
    return this.translations[lang]?.[sanitizedKey] || sanitizedKey;
  }

  translateSignal(key: string) {
    const sanitizedKey = this.sanitizeKey(key);
    if (!this.translationSignalCache.has(sanitizedKey)) {
      this.translationSignalCache.set(
        sanitizedKey,
        computed(() => {
          const lang = this.currentLanguage();
          return this.translations[lang]?.[sanitizedKey] || sanitizedKey;
        })
      );
    }
    return this.translationSignalCache.get(sanitizedKey)!;
  }

  translateAsync(key: string): Observable<string> {
    const sanitizedKey = this.sanitizeKey(key);
    return this.currentLanguage$.pipe(
      map((lang: Language) => this.translations[lang]?.[sanitizedKey] || sanitizedKey)
    );
  }

  private loadLanguage(): Language {
    if (typeof window === 'undefined' || !window.localStorage) {
      return this.DEFAULT_LANGUAGE;
    }

    try {
      const savedLang = localStorage.getItem(this.LANGUAGE_STORAGE_KEY);
      return this.sanitizeLanguage(savedLang as Language);
    } catch {
      return this.DEFAULT_LANGUAGE;
    }
  }

  private saveLanguage(lang: Language): void {
    if (typeof window === 'undefined' || !window.localStorage) {
      return;
    }

    try {
      localStorage.setItem(this.LANGUAGE_STORAGE_KEY, lang);
    } catch {
    }
  }

  private sanitizeLanguage(lang: unknown): Language {
    if (typeof lang === 'string' && this.VALID_LANGUAGES.includes(lang as Language)) {
      return lang as Language;
    }
    return this.DEFAULT_LANGUAGE;
  }

  private sanitizeKey(key: unknown): string {
    if (typeof key === 'string' && key.length > 0 && key.length <= 200) {
      return key;
    }
    return '';
  }
}
